# Mejoras en el Contexto Principal
worker_processes auto; # Usar todos los núcleos de CPU disponibles

events {
    worker_connections 1024; # Aumentar el límite de conexiones
    use epoll;
}

http {
    include      /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Opciones de rendimiento
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    gzip on;
    server_tokens off; # Ocultar versión de Nginx por seguridad

    # Servidor HTTP (Redirección obligatoria a HTTPS)
    server{
        listen 80;
        server_name localhost;
        
        # Redirección 301 (permanente)
        return 301 https://$host$request_uri; 
    }

    # Servidor HTTPS (Principal)
    server{
        # Habilitar SSL y HTTP/2 para mejor rendimiento
        listen 443 ssl http2; 
        server_name localhost;

        # Certificados SSL/TLS
        ssl_certificate /etc/letsencrypt/live/localhost/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/localhost/privkey.pem;

        # Protocolos modernos (TLSv1.2 y TLSv1.3 ya son una buena base)
        ssl_protocols TLSv1.2 TLSv1.3;
        
        # Cifrados fuertes y preferir el orden del servidor
        ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH'; # Ejemplo de lista moderna
        ssl_prefer_server_ciphers on;
        
        # Optimización de la sesión SSL
        ssl_session_cache shared:SSL:10m; 
        ssl_session_timeout 10m;
        
        # OCSP Stapling para validación rápida (Asumiendo que fullchain.pem contiene la cadena)
        # Es posible que necesites un archivo de certificado intermedio separado para ssl_trusted_certificate
        # ssl_stapling on;
        # ssl_stapling_verify on;
        # ssl_trusted_certificate /etc/letsencrypt/live/localhost/chain.pem; 

        # Encabezados de seguridad HSTS y otros
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html; # Mejorado: $uri y $uri/ deben ir antes
        }   
    }
}